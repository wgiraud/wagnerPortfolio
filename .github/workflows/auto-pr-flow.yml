name: Auto PR Flow

on:
  push:
    branches:
      - develop
      - "feature/**"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: auto-pr-${{ github.ref }}
  cancel-in-progress: false

jobs:
  auto-pr:
    name: Create Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Token diagnostics
        run: echo "AUTO_PR_TOKEN configured = ${{ secrets.AUTO_PR_TOKEN != '' }}"

      - name: Create PR if needed
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTO_PR_TOKEN != '' && secrets.AUTO_PR_TOKEN || github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const source = context.ref.replace("refs/heads/", "");

            let target = null;
            if (source.startsWith("feature/")) {
              target = "develop";
            } else if (source === "develop") {
              target = "main";
            }

            if (!target) {
              core.info(`No routing rule for branch ${source}.`);
              return;
            }

            if (source === target) {
              core.info("Source and target are equal; skipping.");
              return;
            }

            try {
              await github.rest.repos.getBranch({
                owner,
                repo,
                branch: target
              });
            } catch (error) {
              if (error.status === 404) {
                core.warning(`Target branch ${target} does not exist yet. Skipping.`);
                return;
              }
              throw error;
            }

            const existing = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: "open",
              head: `${owner}:${source}`,
              base: target,
              per_page: 100
            });

            if (existing.length > 0) {
              core.info(`Open PR already exists: #${existing[0].number}`);
              return;
            }

            const comparison = await github.rest.repos.compareCommits({
              owner,
              repo,
              base: target,
              head: source
            });

            if (comparison.data.ahead_by === 0) {
              core.info(`${source} has no new commits compared to ${target}.`);
              return;
            }

            const title = source.startsWith("feature/")
              ? `feat: merge ${source} into develop`
              : "chore: promote develop to main";

            const body = [
              "This PR was created automatically by the repository workflow.",
              "",
              `- Source: \`${source}\``,
              `- Target: \`${target}\``
            ].join("\n");

            try {
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                head: source,
                base: target,
                title,
                body,
                maintainer_can_modify: true
              });

              core.info(`Created PR #${pr.data.number}: ${pr.data.html_url}`);
            } catch (error) {
              if (error.status === 422) {
                core.info("PR already exists or there are no mergeable changes. Skipping.");
                return;
              }

              if (error.status === 403) {
                core.setFailed(
                  "Token without permission to create PRs. Enable 'Read and write permissions' + 'Allow GitHub Actions to create and approve pull requests' in Actions settings, or configure secret AUTO_PR_TOKEN with repo permissions."
                );
                return;
              }

              throw error;
            }
